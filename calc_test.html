<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculus Run: PFD & Divergence</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 3. Load Lucide React (Icons) - Fixed version to prevent UMD errors -->
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>

    <!-- 4. Load Babel (to compile JSX in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom scrollbar for a "Cyber" feel */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #0891b2; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #06b6d4; 
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200">

    <!-- The container where React will render -->
    <div id="root"></div>

    <!-- The React Code -->
    <script type="text/babel">
        // --- Get components from global variables (since we aren't using 'import') ---
        const { useState, useEffect } = React;
        
        // Use a safe fallback if lucideReact fails to load, though the version fix should resolve it.
        const LucideIcons = window.lucideReact || {};
        const { Play, RotateCcw, CheckCircle, XCircle, Trophy, Timer, TrendingUp, Calculator, Brain } = LucideIcons;

        // --- Utility Component for Fractions ---
        const Fraction = ({ num, den }) => (
            <div className="inline-flex flex-col items-center align-middle mx-2 text-lg font-serif">
                <span className="border-b-2 border-slate-400 px-1 pb-0.5 leading-none">{num}</span>
                <span className="pt-0.5 leading-none">{den}</span>
            </div>
        );

        const Summation = ({ term, lower = "n=1", upper = "∞" }) => (
            <div className="inline-flex items-center align-middle mx-2 gap-2">
                <div className="flex flex-col items-center leading-none text-xl">
                <span className="text-xs">{upper}</span>
                <span className="text-3xl font-serif">∑</span>
                <span className="text-xs">{lower}</span>
                </div>
                {term}
            </div>
        );

        const Limit = ({ term, to = "∞" }) => (
            <div className="inline-flex items-center mx-2 gap-1">
                <span className="font-serif italic">lim</span>
                <sub className="text-xs -ml-1">n→{to}</sub>
                {term}
            </div>
        );

        // --- Question Data ---
        const QUESTIONS = [
            {
                id: 1,
                category: "PFD Setup",
                prompt: (
                <div className="flex flex-col items-center">
                    <p className="mb-4">Which is the correct Partial Fraction Decomposition form for:</p>
                    <div className="text-2xl font-bold bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <Fraction num="3x + 5" den="(x - 1)(x + 4)" />
                    </div>
                </div>
                ),
                options: [
                { id: 'A', label: <div className="flex items-center"><Fraction num="A" den="x-1" /> + <Fraction num="B" den="x+4" /></div> },
                { id: 'B', label: <div className="flex items-center"><Fraction num="A" den="x-1" /> + <Fraction num="Bx + C" den="x+4" /></div> },
                { id: 'C', label: <div className="flex items-center"><Fraction num="A" den="x" /> + <Fraction num="B" den="x^2" /></div> },
                { id: 'D', label: <div className="flex items-center"><Fraction num="Ax + B" den="(x-1)(x+4)" /></div> },
                ],
                correctId: 'A',
                explanation: "Since the denominator consists of distinct linear factors, we use constants A and B over each factor."
            },
            {
                id: 2,
                category: "Test for Divergence",
                prompt: (
                <div className="flex flex-col items-center">
                    <p className="mb-4">Evaluate the series using the n-th Term Test for Divergence:</p>
                    <div className="text-2xl font-bold bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <Summation term={<Fraction num="n" den="3n + 1" />} />
                    </div>
                </div>
                ),
                options: [
                { id: 'A', label: "Converges" },
                { id: 'B', label: "Diverges" },
                { id: 'C', label: "Inconclusive" },
                { id: 'D', label: "Conditionally Converges" },
                ],
                correctId: 'B',
                explanation: (
                <div className="flex items-center flex-wrap justify-center">
                    Because <Limit term={<Fraction num="n" den="3n + 1" />} /> = 1/3 ≠ 0, the series diverges.
                </div>
                )
            },
            {
                id: 3,
                category: "PFD Setup",
                prompt: (
                <div className="flex flex-col items-center">
                    <p className="mb-4">Determine the form for the irreducible quadratic factor:</p>
                    <div className="text-2xl font-bold bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <Fraction num="10" den="x(x^2 + 9)" />
                    </div>
                </div>
                ),
                options: [
                { id: 'A', label: <div className="flex items-center"><Fraction num="A" den="x" /> + <Fraction num="B" den="x^2 + 9" /></div> },
                { id: 'B', label: <div className="flex items-center"><Fraction num="A" den="x" /> + <Fraction num="B" den="x + 3" /> + <Fraction num="C" den="x - 3" /></div> },
                { id: 'C', label: <div className="flex items-center"><Fraction num="A" den="x" /> + <Fraction num="Bx + C" den="x^2 + 9" /></div> },
                { id: 'D', label: <div className="flex items-center"><Fraction num="Ax" den="x" /> + <Fraction num="Bx" den="x^2 + 9" /></div> },
                ],
                correctId: 'C',
                explanation: "For an irreducible quadratic factor (x² + 9), the numerator must be linear (Bx + C)."
            },
            {
                id: 4,
                category: "Test for Divergence",
                prompt: (
                <div className="flex flex-col items-center">
                    <p className="mb-4">What does the Test for Divergence tell us about this series?</p>
                    <div className="text-2xl font-bold bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <Summation term={<Fraction num="1" den="n" />} />
                    </div>
                </div>
                ),
                options: [
                { id: 'A', label: "Converges to 0" },
                { id: 'B', label: "Diverges" },
                { id: 'C', label: "Test is Inconclusive" },
                { id: 'D', label: "Converges to 1" },
                ],
                correctId: 'C',
                explanation: (
                <div className="flex items-center flex-wrap justify-center">
                    <Limit term={<Fraction num="1" den="n" />} /> = 0. When the limit is 0, the Divergence Test tells us NOTHING. (Even though we know the harmonic series diverges, this specific test is inconclusive).
                </div>
                )
            },
            {
                id: 5,
                category: "PFD Solving",
                prompt: (
                <div className="flex flex-col items-center">
                    <p className="mb-4">Solve for constant <strong>A</strong>:</p>
                    <div className="text-2xl font-bold bg-slate-800 p-4 rounded-lg border border-slate-700 mb-4">
                    <Fraction num="5x - 4" den="(x - 2)(x + 1)" /> = <Fraction num="A" den="x - 2" /> + <Fraction num="B" den="x + 1" />
                    </div>
                    <p className="text-sm text-slate-400">(Hint: Use the cover-up method with x = 2)</p>
                </div>
                ),
                options: [
                { id: 'A', label: "A = 2" },
                { id: 'B', label: "A = 3" },
                { id: 'C', label: "A = 5" },
                { id: 'D', label: "A = -2" },
                ],
                correctId: 'A',
                explanation: (
                <div className="flex items-center flex-wrap justify-center">
                    Let x = 2. Cover (x-2). term = <Fraction num="5(2) - 4" den="(2 + 1)" /> = <Fraction num="6" den="3" /> = 2.
                </div>
                )
            }
        ];

        // --- Main App Component ---
        function Calc2Game() {
            const [gameState, setGameState] = useState('start'); // start, playing, end
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [streak, setStreak] = useState(0);
            const [timeLeft, setTimeLeft] = useState(30);
            const [selectedOption, setSelectedOption] = useState(null);
            const [isAnswered, setIsAnswered] = useState(false);
            const [highScore, setHighScore] = useState(0);

            // Timer Effect
            useEffect(() => {
                let timer;
                if (gameState === 'playing' && !isAnswered && timeLeft > 0) {
                timer = setInterval(() => {
                    setTimeLeft((prev) => prev - 1);
                }, 1000);
                } else if (timeLeft === 0 && !isAnswered) {
                handleAnswerTimeOut();
                }
                return () => clearInterval(timer);
            }, [gameState, isAnswered, timeLeft]);

            const startGame = () => {
                setGameState('playing');
                setCurrentQuestionIndex(0);
                setScore(0);
                setStreak(0);
                setTimeLeft(30);
                setSelectedOption(null);
                setIsAnswered(false);
            };

            const handleAnswer = (optionId) => {
                if (isAnswered) return;
                
                setIsAnswered(true);
                setSelectedOption(optionId);
                
                const correct = optionId === QUESTIONS[currentQuestionIndex].correctId;
                
                if (correct) {
                // Base score 100 + Time Bonus + Streak Bonus
                const timeBonus = timeLeft * 5;
                const streakBonus = streak * 50;
                const points = 100 + timeBonus + streakBonus;
                setScore(s => s + points);
                setStreak(s => s + 1);
                } else {
                setStreak(0);
                }
            };

            const handleAnswerTimeOut = () => {
                setIsAnswered(true);
                setSelectedOption('TIMEOUT');
                setStreak(0);
            };

            const nextQuestion = () => {
                if (currentQuestionIndex < QUESTIONS.length - 1) {
                setCurrentQuestionIndex(prev => prev + 1);
                setTimeLeft(30);
                setIsAnswered(false);
                setSelectedOption(null);
                } else {
                endGame();
                }
            };

            const endGame = () => {
                if (score > highScore) setHighScore(score);
                setGameState('end');
            };

            // --- Screens ---

            const StartScreen = () => (
                <div className="flex flex-col items-center justify-center h-full text-center space-y-8 animate-in fade-in zoom-in duration-500">
                <div className="bg-cyan-900/30 p-8 rounded-full ring-4 ring-cyan-500/50 shadow-[0_0_50px_rgba(8,145,178,0.4)]">
                     {Calculator ? <Calculator size={64} className="text-cyan-400" /> : <div className="text-4xl">calc</div>}
                </div>
                <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">
                    CALCULUS RUN
                </h1>
                <p className="text-slate-400 text-lg max-w-md">
                    Test your skills in Partial Fractions and Divergence. 
                    Speed increases score. Streaks grant bonuses.
                </p>
                
                <button 
                    onClick={startGame}
                    className="group relative px-8 py-4 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-xl transition-all hover:scale-105 hover:shadow-[0_0_30px_rgba(8,145,178,0.6)]"
                >
                    <span className="flex items-center gap-2 text-xl">
                    {Play && <Play fill="currentColor" />} START MISSION
                    </span>
                </button>

                {highScore > 0 && (
                    <div className="flex items-center gap-2 text-amber-400 font-mono">
                    {Trophy && <Trophy size={16} />} High Score: {highScore}
                    </div>
                )}
                </div>
            );

            const GameScreen = () => {
                const question = QUESTIONS[currentQuestionIndex];
                const isCorrect = selectedOption === question.correctId;
                
                return (
                <div className="w-full max-w-3xl mx-auto flex flex-col h-full">
                    {/* HUD */}
                    <div className="flex justify-between items-center mb-6 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <div className="flex items-center gap-2 text-amber-400 font-mono text-xl">
                        {Trophy && <Trophy size={20} />}
                        <span>{score}</span>
                    </div>
                    
                    <div className={`flex items-center gap-2 font-mono text-xl ${timeLeft <= 10 ? 'text-red-500 animate-pulse' : 'text-cyan-400'}`}>
                        {Timer && <Timer size={20} />}
                        <span>{timeLeft}s</span>
                    </div>
                    
                    <div className="flex items-center gap-2 text-purple-400 font-mono text-xl">
                        {TrendingUp && <TrendingUp size={20} />}
                        <span>x{streak + 1}</span>
                    </div>
                    </div>

                    {/* Progress Bar */}
                    <div className="w-full bg-slate-800 h-2 rounded-full mb-6 overflow-hidden">
                    <div 
                        className="bg-gradient-to-r from-cyan-500 to-blue-500 h-full transition-all duration-500"
                        style={{ width: `${((currentQuestionIndex) / QUESTIONS.length) * 100}%` }}
                    />
                    </div>

                    {/* Question Card */}
                    <div className="flex-grow flex flex-col items-center">
                    <div className="w-full bg-slate-900 border border-slate-700 p-6 rounded-2xl shadow-xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10">
                        {Brain && <Brain size={120} />}
                        </div>
                        
                        <span className="inline-block px-3 py-1 rounded-full bg-slate-800 text-slate-400 text-xs font-bold tracking-wider mb-4 border border-slate-700">
                        QUESTION {currentQuestionIndex + 1} / {QUESTIONS.length} • {question.category}
                        </span>
                        
                        <div className="text-xl md:text-2xl text-white font-medium mb-8 z-10 relative">
                        {question.prompt}
                        </div>

                        {/* Options Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full z-10 relative">
                        {question.options.map((opt) => {
                            let statusClass = "bg-slate-800 border-slate-600 hover:bg-slate-750 hover:border-cyan-500";
                            
                            if (isAnswered) {
                            if (opt.id === question.correctId) {
                                statusClass = "bg-green-900/50 border-green-500 ring-1 ring-green-500";
                            } else if (opt.id === selectedOption) {
                                statusClass = "bg-red-900/50 border-red-500 opacity-50";
                            } else {
                                statusClass = "bg-slate-800 border-slate-700 opacity-50";
                            }
                            }

                            return (
                            <button
                                key={opt.id}
                                onClick={() => handleAnswer(opt.id)}
                                disabled={isAnswered}
                                className={`p-4 rounded-xl border-2 transition-all duration-200 text-left flex items-center gap-3 ${statusClass}`}
                            >
                                <div className="w-8 h-8 rounded-full bg-slate-900 flex items-center justify-center font-bold text-slate-400 text-sm shrink-0">
                                {opt.id}
                                </div>
                                <div className="text-lg font-medium text-slate-200">
                                {opt.label}
                                </div>
                            </button>
                            );
                        })}
                        </div>
                    </div>

                    {/* Feedback & Next Button */}
                    {isAnswered && (
                        <div className="mt-6 w-full animate-in slide-in-from-bottom-4 fade-in duration-300">
                        <div className={`p-4 rounded-xl border ${isCorrect ? 'bg-green-900/20 border-green-800' : 'bg-red-900/20 border-red-800'} mb-4`}>
                            <div className="flex items-center gap-2 mb-2">
                            {isCorrect ? (CheckCircle && <CheckCircle className="text-green-500" />) : (XCircle && <XCircle className="text-red-500" />)}
                            <h3 className={`font-bold ${isCorrect ? 'text-green-400' : 'text-red-400'}`}>
                                {isCorrect ? 'Correct!' : 'Incorrect'}
                            </h3>
                            </div>
                            <div className="text-slate-300">
                            {question.explanation}
                            </div>
                        </div>
                        
                        <button 
                            onClick={nextQuestion}
                            className="w-full py-4 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-xl transition-colors shadow-lg shadow-cyan-900/20"
                        >
                            {currentQuestionIndex === QUESTIONS.length - 1 ? "Finish Game" : "Next Question"}
                        </button>
                        </div>
                    )}
                    </div>
                </div>
                );
            };

            const EndScreen = () => (
                <div className="flex flex-col items-center justify-center h-full text-center space-y-6 animate-in zoom-in duration-500">
                <div className="relative">
                    {Trophy && <Trophy size={80} className="text-amber-400 mb-4 drop-shadow-[0_0_15px_rgba(251,191,36,0.5)]" />}
                    <div className="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-bounce">
                    DONE!
                    </div>
                </div>
                
                <h2 className="text-4xl font-bold text-white">Mission Complete</h2>
                
                <div className="grid grid-cols-2 gap-4 w-full max-w-sm mt-8">
                    <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div className="text-slate-400 text-sm uppercase tracking-wider mb-1">Final Score</div>
                    <div className="text-3xl font-mono text-cyan-400 font-bold">{score}</div>
                    </div>
                    <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div className="text-slate-400 text-sm uppercase tracking-wider mb-1">Top Streak</div>
                    <div className="text-3xl font-mono text-purple-400 font-bold">{streak}</div>
                    </div>
                </div>

                <p className="text-slate-400 max-w-md mt-4">
                    {score > 2000 ? "Amazing! You're ready for the exam." : 
                    score > 1000 ? "Good job! Keep practicing those decompositions." :
                    "Keep reviewing your divergence tests!"}
                </p>

                <button 
                    onClick={startGame}
                    className="mt-8 px-8 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl transition-all flex items-center gap-2"
                >
                    {RotateCcw && <RotateCcw size={20} />} Play Again
                </button>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-cyan-500/30">
                <div className="max-w-4xl mx-auto p-4 h-screen flex flex-col">
                    {gameState === 'start' && <StartScreen />}
                    {gameState === 'playing' && <GameScreen />}
                    {gameState === 'end' && <EndScreen />}
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Calc2Game />);
    </script>
</body>
</html>
